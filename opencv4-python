import cv2
import numpy as np
import os

def complete_text_detection_workflow():
    """
    å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½å¯è§
    """
    print("=== æ–‡å­—æ£€æµ‹å®Œæ•´å·¥ä½œæµç¨‹ ===")
    
    # æ­¥éª¤1: ç¡®è®¤å·¥ä½œç›®å½•
    current_dir = os.getcwd()
    print(f"ğŸ“ å½“å‰å·¥ä½œç›®å½•: {current_dir}")
    print("å½“å‰ç›®å½•å†…å®¹:")
    for item in os.listdir('.'):
        if os.path.isfile(item):
            print(f"   ğŸ“„ {item}")
        else:
            print(f"   ğŸ“‚ {item}/")
    
    # æ­¥éª¤2: æŸ¥æ‰¾å›¾ç‰‡æ–‡ä»¶
    image_files = []
    for file in os.listdir('.'):
        if file.lower().endswith(('.jpg', '.jpeg', '.png')):
            image_files.append(file)
    
    if not image_files:
        print("âŒ æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶ï¼")
        print("ğŸ’¡ è¯·å°†å›¾ç‰‡æ–‡ä»¶æ”¾åœ¨å½“å‰ç›®å½•ä¸­")
        return
    
    # æ­¥éª¤3: åˆ›å»ºç»“æœç›®å½•
    result_dir = "detection_results"
    os.makedirs(result_dir, exist_ok=True)
    print(f"âœ… åˆ›å»ºç»“æœç›®å½•: {result_dir}")
    
    # æ­¥éª¤4: å¤„ç†æ¯ä¸ªå›¾ç‰‡
    for image_file in image_files:
        print(f"\nğŸ¬ å¤„ç†å›¾ç‰‡: {image_file}")
        
        # è¯»å–å›¾ç‰‡
        img = cv2.imread(image_file)
        if img is None:
            print(f"âŒ æ— æ³•è¯»å– {image_file}")
            continue
        
        print(f"âœ… å›¾ç‰‡å°ºå¯¸: {img.shape[1]}x{img.shape[0]}")
        
        # å®Œæ•´çš„å¤„ç†æµç¨‹
        # 1. ç°åº¦å›¾
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        cv2.imwrite(os.path.join(result_dir, f"1_gray_{image_file}"), gray)
        
        # 2. äºŒå€¼åŒ–
        _, binary = cv2.threshold(gray, 200, 255, cv2.THRESH_BINARY_INV)
        cv2.imwrite(os.path.join(result_dir, f"2_binary_{image_file}"), binary)
        
        # 3. è†¨èƒ€
        kernel = np.ones((2, 2), np.uint8)
        dilated = cv2.dilate(binary, kernel, iterations=1)
        cv2.imwrite(os.path.join(result_dir, f"3_dilated_{image_file}"), dilated)
        
        # 4. æŸ¥æ‰¾è½®å»“
        contours, _ = cv2.findContours(dilated, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # 5. æè¾¹
        result = img.copy()
        text_count = 0
        
        for contour in contours:
            area = cv2.contourArea(contour)
            if 20 < area < 5000:
                cv2.drawContours(result, [contour], -1, (0, 0, 255), 2)
                text_count += 1
        
        # 6. ä¿å­˜æœ€ç»ˆç»“æœ
        final_output = os.path.join(result_dir, f"4_final_{image_file}")
        success = cv2.imwrite(final_output, result)
        
        if success:
            print(f"âœ… æˆåŠŸå¤„ç†ï¼æ£€æµ‹åˆ° {text_count} ä¸ªæ–‡å­—åŒºåŸŸ")
            print(f"ğŸ’¾ ç»“æœä¿å­˜ä¸º: {final_output}")
            print(f"ğŸ“ å®Œæ•´è·¯å¾„: {os.path.abspath(final_output)}")
        else:
            print(f"âŒ ä¿å­˜å¤±è´¥: {final_output}")

# è¿è¡Œå®Œæ•´æµç¨‹
if __name__ == "__main__":
    complete_text_detection_workflow()
